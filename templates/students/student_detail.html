{% extends "base.html" %}
{% load humanize %}

{% block content %}
<style>
    /* ê³µí†µ ìŠ¤íƒ€ì¼ */
    .info-card {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        margin-bottom: 30px; /* ì¹´ë“œ ê°„ ê°„ê²© í™•ë³´ */
    }

    .info-card h3 {
        margin-top: 0;
        border-bottom: 2px solid #673ab7;
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-size: 1.2rem;
        color: #4527a0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .info-row { display: flex; border-bottom: 1px solid #f0f0f0; padding: 12px 0; }
    .info-row:last-child { border-bottom: none; }
    .info-label { flex: 0 0 140px; font-weight: 600; color: #666; }
    .info-value { flex: 1; color: #333; font-weight: 500; word-break: break-word; }

    table th, table td { vertical-align: middle; }

    /* ìš”ì•½ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .summary-card {
        background-color: #fff8e1;
        border: 2px solid #ffb74d;
        border-radius: 10px;
        padding: 20px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        margin-top: 20px;
    }
    .summary-item { text-align: center; }
    .summary-label { font-size: 0.9rem; color: #795548; margin-bottom: 5px; font-weight: bold; }
    .summary-value { font-size: 1.4rem; font-weight: bold; color: #d32f2f; }
    .summary-plus { font-size: 1.5rem; color: #bbb; font-weight: bold; }
</style>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h2 style="margin:0; font-size: 1.8rem; display: flex; align-items: center; gap: 10px;">
        {% if student.status == 'ATTENDING' %}
            <span style="color:#673ab7;">â—</span>
        {% elif student.status == 'DISCHARGED' %}
            <span style="color:#999;">â—</span>
        {% else %}
            <span style="color:#ff9800;">â—</span>
        {% endif %}

        {{ student.name }}

        <span style="font-size: 1.2rem; color: #777; font-weight: normal;">
            ({{ student.grade }})
            <span style="font-size: 0.9rem; padding: 2px 8px; border-radius: 12px; vertical-align: middle;
                  {% if student.status == 'ATTENDING' %}background:#e8eaf6; color:#3f51b5;
                  {% elif student.status == 'DISCHARGED' %}background:#f5f5f5; color:#999;
                  {% else %}background:#fff3e0; color:#ef6c00;{% endif %}">
                {{ student.get_status_display }}
            </span>
        </span>
    </h2>

    <div style="display: flex; gap: 5px;">
        <a href="{% url 'student_sms_send' student.pk %}" class="btn" style="background-color: #673ab7;">ğŸ“© ë¬¸ì</a>
        <a href="{% url 'student_update' student.pk %}" class="btn" style="background-color: #ff9800;">ìˆ˜ì •</a>

        <form action="{% url 'student_delete' student.pk %}" method="POST" style="margin:0;">
            {% csrf_token %}
            <button type="submit" onclick="return confirm('âš ï¸ ê²½ê³ : ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní•™ìƒì˜ ìˆ˜ê°• ê¸°ë¡, ê²°ì œ ë‚´ì—­, ìƒë‹´ ì¼ì§€ ë“± ëª¨ë“  ì •ë³´ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.\n(ë‹¨ìˆœíˆ ê·¸ë§Œë‘” í•™ìƒì´ë¼ë©´ \'ì •ë³´ ìˆ˜ì •\'ì—ì„œ ìƒíƒœë¥¼ \'í‡´ì›\'ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”.)');"
                    class="btn" style="background-color: #e53935;">
                ì‚­ì œ
            </button>
        </form>
    </div>
</div>

<div class="info-card">
    <h3>ğŸ‘¤ ê¸°ë³¸ ì •ë³´</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        <div>
            <div class="info-row"><div class="info-label">ê³ ìœ ë²ˆí˜¸</div><div class="info-value" style="color:#4527a0; font-weight:bold;">{{ student.student_number }}</div></div>
            <div class="info-row"><div class="info-label">í•™êµ</div><div class="info-value">{{ student.school|default:"-" }}</div></div>
            <div class="info-row"><div class="info-label">ì„±ë³„</div><div class="info-value">{{ student.get_gender_display }}</div></div>
            <div class="info-row"><div class="info-label">ì´ë©”ì¼</div><div class="info-value">{{ student.email|default:"-" }}</div></div>
        </div>
        <div>
            <div class="info-row"><div class="info-label">í•™ìƒ ì—°ë½ì²˜</div><div class="info-value">{{ student.student_phone|default:"-" }}</div></div>
            <div class="info-row"><div class="info-label">ë¶€ëª¨ë‹˜ ì—°ë½ì²˜</div><div class="info-value">{{ student.parent_phone|default:"-" }}</div></div>
            <div class="info-row"><div class="info-label">í˜„ê¸ˆì˜ìˆ˜ì¦</div><div class="info-value">{{ student.receipt_phone|default:"-" }}</div></div>
            <div class="info-row"><div class="info-label">ë“±ë¡ì¼</div><div class="info-value">{{ student.created_at|date:"Y-m-d" }}</div></div>
        </div>
    </div>
</div>

<div class="info-card" style="border-left: 5px solid #7e57c2;">
    <h3>
        <span>ğŸ‘¨â€ğŸ« ìˆ˜ê°• ì‹ ì²­ ë° ê´€ë¦¬</span>
        <a href="{% url 'student_class_edit' student.pk %}" class="btn" style="background-color: #7e57c2; font-size: 0.9rem;">âš™ï¸ ìˆ˜ê°• ë³€ê²½</a>
    </h3>

    {% if student.enrolled_classes.exists %}
        <ul style="padding: 0; list-style: none;">
            {% for class in student.enrolled_classes.all %}
                <li style="margin-bottom: 10px; padding: 15px; background-color: #f5f5f5; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="font-size: 1.1rem; color: #333;">{{ class.name }}</strong>
                        <span style="color: #666; font-size: 0.9rem; margin-left: 5px;">
                            (T. {{ class.teacher.name|default:"ë¯¸ì •" }})
                        </span>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">
                            {{ class.get_formatted_schedule }}
                        </div>
                        <div style="font-size: 0.9rem; color: #d32f2f; font-weight: bold; margin-top: 5px;">
                            ìˆ˜ê°•ë£Œ: {{ class.tuition_fee|intcomma }}ì›
                        </div>
                    </div>

                    <div style="display: flex; gap: 5px; align-items: center;">
{#                        <form action="{% url 'tuition_charge' student.pk class.pk %}" method="POST" style="margin:0;">#}
{#                            {% csrf_token %}#}
{#                            <button type="submit" onclick="return confirm('ì´ë²ˆ ë‹¬ ìˆ˜ê°•ë£Œë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì²­êµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"#}
{#                                    style="background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold;">#}
{#                                ï¿¦ ì²­êµ¬#}
{#                            </button>#}
{#                        </form>#}
                        <form action="{% url 'student_class_drop' student.pk class.pk %}" method="POST" style="margin:0;">
                            {% csrf_token %}
                            <button type="submit" onclick="return confirm('ì •ë§ ìˆ˜ê°•ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në¯¸ë‚©ëœ ìˆ˜ê°•ë£Œ ë‚´ì—­ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.');"
                                    style="background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                ğŸ—‘ï¸ ì‚­ì œ
                            </button>
                        </form>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <div style="text-align: center; padding: 30px; color: #999; background-color: #fafafa; border-radius: 8px;">
            <p>í˜„ì¬ ìˆ˜ê°• ì¤‘ì¸ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    {% endif %}
</div>

<div class="info-card">
    <h3>ğŸ“ ìƒë‹´ ì¼ì§€ ë° íŒŒì¼</h3>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
        <div>
            <h4 style="margin-top:0; color:#666; font-size:1rem;">ìƒë‹´ ì •ë³´</h4>
            <div class="info-row"><div class="info-label">ì¸í„°ë·° ë‚ ì§œ</div><div class="info-value">{{ student.interview_date|default:"-" }}</div></div>
            <div class="info-row"><div class="info-label">ì¸í„°ë·° ì„±ì </div><div class="info-value">{{ student.interview_score|default:"-" }}</div></div>
            <div class="info-row"><div class="info-label">ì¸í„°ë·° ì •ë³´</div><div class="info-value">{{ student.interview_info|default:"-"|linebreaksbr }}</div></div>
        </div>
        <div>
            <h4 style="margin-top:0; color:#666; font-size:1rem;">í•™ì  ì •ë³´</h4>
            <div class="info-row"><div class="info-label">ì²« ìˆ˜ì—…ì¼</div><div class="info-value">{{ student.first_class_date|default:"-" }}</div></div>
            <div class="info-row"><div class="info-label">ì¢…ê°•ì¼</div><div class="info-value">{{ student.last_class_date|default:"-" }}</div></div>
            <div class="info-row"><div class="info-label">ì°¸ê³  ì‚¬í•­</div><div class="info-value">{{ student.misc|default:"-"|linebreaksbr }}</div></div>
        </div>
    </div>

    <div style="background-color: #f3e5f5; padding: 15px; border-radius: 8px; border: 1px solid #e1bee7;">
        <h4 style="margin-top:0; margin-bottom: 10px; color: #4a148c; font-size: 1rem;">ğŸ“ íŒŒì¼ ì²¨ë¶€</h4>

        <form method="POST" enctype="multipart/form-data" style="display: flex; gap: 10px; flex-direction: column;">
            {% csrf_token %}
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">{{ file_form.file }}</div>
            </div>
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">{{ file_form.description }}</div>
                <button type="submit" class="btn" style="padding: 8px 20px; background-color: #7b1fa2;">ì—…ë¡œë“œ</button>
            </div>
            <small style="color: #666;">* Ctrl í‚¤ë¥¼ ëˆ„ë¥´ê³  ì—¬ëŸ¬ íŒŒì¼ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
        </form>

        {% if files %}
            <div style="margin-top: 15px; border-top: 1px solid #d1c4e9; padding-top: 10px;">
                <table style="font-size: 0.9rem; width: 100%;">
                    {% for file in files %}
                    <tr>
                        <td style="padding: 5px 0;">
                            <a href="{{ file.file.url }}" target="_blank" style="text-decoration: underline; color: #4a148c; font-weight: bold;">
                                ğŸ“„ {{ file }}
                            </a>
                            <span style="color:#888; font-size: 0.8rem; margin-left: 5px;">({{ file.uploaded_at|date:"Y-m-d" }})</span>
                        </td>
                        <td style="color: #555;">{{ file.description|default:"" }}</td>
                        <td style="text-align: right;">
                            <form action="{% url 'delete_student_file' file.pk %}" method="POST" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                                        style="color: #c62828; border: none; background: none; cursor: pointer; font-size: 0.8rem;">
                                    [ì‚­ì œ]
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        {% endif %}
    </div>
</div>

<hr style="margin: 40px 0; border: 0; border-top: 2px dashed #ddd;">

<div class="info-card" style="border-left: 5px solid #ff9800;">
    <h3>
        <span style="color: #e65100;">ğŸ“š êµì¬ êµ¬ë§¤/ì§€ê¸‰ ë‚´ì—­</span>
        <a href="{% url 'book_sale_create' student.pk %}" class="btn" style="background-color: #e65100; font-size: 0.9rem;">+ êµì¬ íŒë§¤</a>
    </h3>

    <table>
        <thead style="background-color: #fff3e0;">
            <tr>
                <th>ë‚ ì§œ</th>
                <th>êµì¬ëª…</th>
                <th style="text-align: center;">ìˆ˜ëŸ‰</th>
                <th style="text-align: right;">ë‹¨ê°€</th>
                <th style="text-align: right;">í•©ê³„</th>
                <th style="text-align: center;">ìƒíƒœ / ê´€ë¦¬</th>
                <th>ë¹„ê³ </th>
            </tr>
        </thead>
        <tbody>
            {% for sale in student.book_sales.all %}
            <tr>
                <td>{{ sale.sale_date|date:"Y-m-d" }}</td>
                <td style="font-weight: bold;">{{ sale.book.title }}</td>
                <td style="text-align: center;">{{ sale.quantity }}</td>
                <td style="text-align: right;">{{ sale.price|intcomma }}</td>
                <td style="text-align: right; font-weight: bold;">{{ sale.get_total_price|intcomma }}</td>
                <td style="text-align: center;">
                    {% if sale.is_paid %}
                        <span style="color: #2e7d32; font-weight: bold;">
                            âœ… ì™„ë£Œ <span style="font-size:0.8rem; color:#666;">({{ sale.payment_date|date:"m/d" }})</span>
                        </span>
                    {% else %}
                        <form action="{% url 'book_sale_settle' sale.pk %}" method="POST" style="margin: 0;">
                            {% csrf_token %}
                            <div style="display: flex; gap: 5px; justify-content: center; align-items: center; white-space: nowrap;">
                                <input type="date" name="payment_date" value="{% now 'Y-m-d' %}" required
                                       style="padding: 4px; border: 1px solid #ffcc80; border-radius: 4px; width: auto; font-size: 0.8rem;">
                                <button type="submit" class="btn" onclick="return confirm('ë‚©ë¶€ ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                                        style="background-color: #ff9800; padding: 4px 10px; font-size: 0.8rem; white-space: nowrap;">
                                    ë‚©ë¶€
                                </button>
                            </div>
                        </form>
                    {% endif %}
                </td>
                <td style="color: #888;">{{ sale.memo|default:"-" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">êµì¬ êµ¬ë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr style="background-color: #fff3e0; color: #795548;">
                <td colspan="4" style="text-align: right; padding: 10px; font-weight: bold;">ğŸ“š êµì¬ ë¯¸ë‚© í•©ê³„:</td>
                <td colspan="3" style="font-weight: bold; padding: 10px; color: #e65100;">{{ unpaid_book_total|intcomma }}ì›</td>
            </tr>
        </tfoot>
    </table>
</div>

<div class="info-card" style="border-left: 5px solid #2196f3;">
    <h3>
        <span style="color: #1565c0;">ğŸ« ìˆ˜ê°•ë£Œ ì²­êµ¬/ë‚©ë¶€ ë‚´ì—­</span>
    </h3>

    <table>
        <thead style="background-color: #e3f2fd;">
            <tr>
                <th>ì²­êµ¬ì¼</th>
                <th>ìˆ˜ì—…ëª…</th>
                <th>ë‚´ìš© (ì›”)</th>
                <th style="text-align: right;">ì²­êµ¬ ê¸ˆì•¡</th>
                <th style="text-align: center;">ìƒíƒœ / ê´€ë¦¬</th>
                <th>ë¹„ê³ </th>
            </tr>
        </thead>
        <tbody>
            {% for log in student.tuition_logs.all %}
            <tr>
                <td>{{ log.charge_date|date:"Y-m-d" }}</td>
                <td style="font-weight: bold;">{{ log.class_info.name }}</td>
                <td>{{ log.month }}</td>
                <td style="text-align: right; font-weight: bold;">{{ log.amount|intcomma }}</td>
                <td style="text-align: center;">
                    {% if log.is_paid %}
                        <span style="color: #2e7d32; font-weight: bold;">
                            âœ… ì™„ë£Œ <span style="font-size:0.8rem; color:#666;">({{ log.payment_date|date:"m/d" }})</span>
                        </span>
                    {% else %}
                        <form action="{% url 'tuition_settle' log.pk %}" method="POST" style="margin: 0;">
                            {% csrf_token %}
                            <div style="display: flex; gap: 5px; justify-content: center; align-items: center; white-space: nowrap;">
                                <input type="date" name="payment_date" value="{% now 'Y-m-d' %}" required
                                       style="padding: 4px; border: 1px solid #90caf9; border-radius: 4px; width: auto; font-size: 0.8rem;">
                                <button type="submit" class="btn" onclick="return confirm('ìˆ˜ê°•ë£Œ ë‚©ë¶€ ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                                        style="background-color: #2196f3; padding: 4px 10px; font-size: 0.8rem; white-space: nowrap;">
                                    ë‚©ë¶€
                                </button>
                            </div>
                        </form>
                    {% endif %}
                </td>
                <td style="color: #888;">{{ log.memo|default:"-" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">ìˆ˜ê°•ë£Œ ì²­êµ¬ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr style="background-color: #e3f2fd; color: #1565c0;">
                <td colspan="3" style="text-align: right; padding: 10px; font-weight: bold;">ğŸ« ìˆ˜ê°•ë£Œ ë¯¸ë‚© í•©ê³„:</td>
                <td colspan="3" style="font-weight: bold; padding: 10px; color: #1565c0;">{{ unpaid_tuition_total|intcomma }}ì›</td>
            </tr>
        </tfoot>
    </table>
</div>

<div class="summary-card">
    <div class="summary-item">
        <div class="summary-label">ğŸ“š êµì¬ ë¯¸ë‚©</div>
        <div class="summary-value" style="color: #fb8c00;">{{ unpaid_book_total|intcomma }}ì›</div>
    </div>
    <div class="summary-plus">+</div>
    <div class="summary-item">
        <div class="summary-label">ğŸ« ìˆ˜ê°•ë£Œ ë¯¸ë‚©</div>
        <div class="summary-value" style="color: #1976d2;">{{ unpaid_tuition_total|intcomma }}ì›</div>
    </div>
    <div class="summary-plus">=</div>
    <div class="summary-item">
        <div class="summary-label">ğŸ’° ì´ ë‚©ë¶€í•  ê¸ˆì•¡</div>
        <div class="summary-value" style="font-size: 1.8rem; color: #d32f2f;">{{ student.unpaid_amount|intcomma }}ì›</div>
    </div>
</div>

<div style="margin-top: 30px; text-align: center;">
    <a href="{% url 'student_list' %}" class="btn" style="background-color: #757575;">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
</div>

{% endblock %}