{% extends "base.html" %}
{% load humanize %}

{% block container_class %}wide-screen{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2 style="margin:0; color: #4527a0;">ğŸ¢ {{ supplier.name }} ìƒì„¸ ì •ë³´</h2>
    <a href="{% url 'supplier_list' %}" class="btn" style="background-color: #757575;">â† ëª©ë¡ìœ¼ë¡œ</a>
</div>

<div class="info-card" style="background-color: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
            <p><strong>ì‚¬ì—…ì ë²ˆí˜¸:</strong> {{ supplier.registration_number|default:"-" }}</p>
            <p><strong>ì „í™”ë²ˆí˜¸:</strong> {{ supplier.phone|default:"-" }}</p>
            <p><strong>ì£¼ì†Œ:</strong> {{ supplier.address|default:"-" }}</p>
        </div>
        <div style="background-color: #f3e5f5; padding: 15px; border-radius: 8px;">
            <h4 style="margin-top: 0; color: #4527a0;">ğŸ’° ê³„ì¢Œ ì •ë³´</h4>
            <p style="margin-bottom: 5px;"><strong>{{ supplier.bank_name }}</strong> {{ supplier.account_number }}</p>
            <p style="margin: 0;">ì˜ˆê¸ˆì£¼: {{ supplier.account_owner }}</p>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">

    <div>
        <h3 style="border-bottom: 2px solid #e65100; padding-bottom: 10px; color: #e65100;">
            ğŸ’¸ ì§€ê¸‰(ì…ê¸ˆ) ì˜ˆì • ëª©ë¡
            <span style="float: right; font-size: 0.9rem; color: #666;">ì´ì•¡: <strong>{{ total_to_pay|intcomma }}ì›</strong></span>
        </h3>

        <form method="POST" action="{% url 'supplier_settle' supplier.pk %}">
            {% csrf_token %}

            <div style="background-color: #fff3e0; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: flex-end; align-items: center;">
                 <label style="font-weight: bold; margin-right: 10px; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                    ğŸ“… ì§€ê¸‰ì¼:
                    <input type="date" name="payment_date" value="{{ today }}" required style="border: 1px solid #ccc; padding: 3px;">
                </label>
                <button type="submit" class="btn" onclick="return confirm('ì„ íƒí•œ ì…ê³  ê±´ì„ ì§€ê¸‰ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                        style="background-color: #e65100; padding: 5px 10px; font-size: 0.8rem;">
                    ì§€ê¸‰ ì²˜ë¦¬
                </button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="text-align: center; width: 40px;">
                            <input type="checkbox" onclick="toggleAll(this)" aria-label="ëª¨ë‘ ì„ íƒ">
                        </th>
                        <th>ì…ê³ ì¼</th>
                        <th>ë„ì„œëª…</th>
                        <th style="text-align: center;">ìˆ˜ëŸ‰</th>
                        <th style="text-align: right;">ê¸ˆì•¡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in unpaid_restocks %}
                    <tr>
                        <td style="text-align: center;">
                            <input type="checkbox" name="log_ids" value="{{ log.pk }}" aria-label="ì„ íƒ">
                        </td>
                        <td>{{ log.created_at|date:"Y-m-d" }}</td>
                        <td style="font-size: 0.9rem; font-weight: bold;">{{ log.book.title }}</td>
                        <td style="text-align: center; color: #2e7d32;">+{{ log.quantity }}</td>
                        <td style="text-align: right;">{{ log.total_payment|intcomma }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" style="text-align: center; color: #999; padding: 20px;">ì§€ê¸‰ ëŒ€ê¸° ì¤‘ì¸ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </form>
    </div>

    <div>
        <h3 style="border-bottom: 2px solid #1976d2; padding-bottom: 10px; color: #1976d2;">
            â†©ï¸ í™˜ë¶ˆ(ì°¨ê°) ì˜ˆì • ëª©ë¡
            <span style="float: right; font-size: 0.9rem; color: #666;">ì´ì•¡: <strong>{{ total_to_refund|intcomma }}ì›</strong></span>
        </h3>

        <form method="POST" action="{% url 'supplier_settle' supplier.pk %}">
            {% csrf_token %}

            <div style="background-color: #e3f2fd; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: flex-end; align-items: center;">
                 <label style="font-weight: bold; margin-right: 10px; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                    ğŸ“… í™˜ë¶ˆì¼:
                    <input type="date" name="payment_date" value="{{ today }}" required style="border: 1px solid #ccc; padding: 3px;">
                 </label>
                <button type="submit" class="btn" onclick="return confirm('ì„ íƒí•œ ë°˜í’ˆ ê±´ì„ ì •ì‚°(ì°¨ê°) ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                        style="background-color: #1976d2; padding: 5px 10px; font-size: 0.8rem;">
                    í™˜ë¶ˆ í™•ì¸
                </button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="text-align: center; width: 40px;">
                            <input type="checkbox" onclick="toggleAll(this)" aria-label="ëª¨ë‘ ì„ íƒ">
                        </th>
                        <th>ë°˜í’ˆì¼</th>
                        <th>ë„ì„œëª…</th>
                        <th style="text-align: center;">ìˆ˜ëŸ‰</th>
                        <th style="text-align: right;">ê¸ˆì•¡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in unpaid_returns %}
                    <tr>
                        <td style="text-align: center;">
                            <input type="checkbox" name="log_ids" value="{{ log.pk }}" aria-label="ì„ íƒ">
                        </td>
                        <td>{{ log.created_at|date:"Y-m-d" }}</td>
                        <td style="font-size: 0.9rem; font-weight: bold;">{{ log.book.title }}</td>
                        <td style="text-align: center; color: #c62828;">{{ log.quantity }}</td>
                        <td style="text-align: right;">{{ log.total_payment|intcomma }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" style="text-align: center; color: #999; padding: 20px;">í™˜ë¶ˆ ëŒ€ê¸° ì¤‘ì¸ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </form>
    </div>
</div>

<hr style="margin: 40px 0; border: 0; border-top: 2px dashed #ddd;">

<h3 style="color: #2e7d32; margin-bottom: 15px;">âœ… ì •ì‚°(ì…ê¸ˆ/í™˜ë¶ˆ) ì™„ë£Œ ê¸°ë¡</h3>

<form method="POST" action="{% url 'supplier_payment_cancel' supplier.pk %}">
    {% csrf_token %}

    <div style="text-align: right; margin-bottom: 10px;">
        <button type="submit" class="btn" onclick="return confirm('ì„ íƒí•œ í•­ëª©ì˜ ì •ì‚° ì²˜ë¦¬ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì·¨ì†Œëœ í•­ëª©ì€ ë‹¤ì‹œ \'ë¯¸ì •ì‚° ëª©ë¡\'ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');"
                style="background-color: #9e9e9e; font-size: 0.9rem; padding: 8px 15px;">
            â†º ì„ íƒ í•­ëª© ì •ì‚° ì·¨ì†Œ (ìˆ˜ì •)
        </button>
    </div>

    <table>
        <thead style="background-color: #e8f5e9;">
            <tr>
                <th style="text-align: center; width: 40px;">
                    <input type="checkbox" onclick="toggleAll(this)" aria-label="ëª¨ë‘ ì„ íƒ">
                </th>
                <th>ì •ì‚°(ì§€ê¸‰)ì¼</th>
                <th>ì…ê³ /ë°˜í’ˆì¼</th>
                <th>ë„ì„œëª…</th>
                <th style="text-align: center;">ìˆ˜ëŸ‰</th>
                <th style="text-align: right;">ë‹¨ê°€</th>
                <th style="text-align: right;">í•©ê³„</th>
                <th>ë¹„ê³ </th>
            </tr>
        </thead>
        <tbody>
            {% for log in paid_logs %}
            <tr>
                <td style="text-align: center;">
                    <input type="checkbox" name="log_ids" value="{{ log.pk }}" aria-label="ì„ íƒ">
                </td>
                <td style="font-weight: bold; color: #2e7d32;">{{ log.payment_date|date:"Y-m-d" }}</td>
                <td style="color: #888;">{{ log.created_at|date:"Y-m-d" }}</td>
                <td>{{ log.book.title }}</td>
                <td style="text-align: center;">
                    {% if log.quantity > 0 %}
                        <span>+{{ log.quantity }}</span>
                    {% else %}
                        <span style="color: #c62828;">{{ log.quantity }}</span>
                    {% endif %}
                </td>
                <td style="text-align: right; color: #666;">{{ log.cost_price|intcomma }}</td>
                <td style="text-align: right; font-weight: bold;">
                    {% if log.quantity > 0 %}
                         {{ log.total_payment|intcomma }}ì›
                    {% else %}
                        <span style="color: #c62828;">-{{ log.total_payment|intcomma }}ì›</span> (ë°˜í’ˆ)
                    {% endif %}
                </td>
                <td style="color: #666; font-size: 0.9rem;">{{ log.memo|default:"-" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" style="text-align: center; padding: 30px; color: #999;">
                    ì •ì‚° ì™„ë£Œëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</form>

<script>
    /**
     * ì „ì²´ ì„ íƒ/í•´ì œ ìŠ¤í¬ë¦½íŠ¸
     * [í•µì‹¬] í´ë¦­ëœ ì²´í¬ë°•ìŠ¤(source)ê°€ ì†í•œ form ë‚´ë¶€ì˜ ì²´í¬ë°•ìŠ¤ë“¤ë§Œ ì œì–´í•©ë‹ˆë‹¤.
     * ì´ë¥¼ í†µí•´ 3ê°œì˜ í¼(ì§€ê¸‰, í™˜ë¶ˆ, ì™„ë£Œ)ì˜ ì²´í¬ë°•ìŠ¤ê°€ ì„œë¡œ ê°„ì„­í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
     */
    function toggleAll(source) {
        const form = source.closest('form');
        const checkboxes = form.querySelectorAll('input[name="log_ids"]');
        checkboxes.forEach(cb => cb.checked = source.checked);
    }
</script>
{% endblock %}