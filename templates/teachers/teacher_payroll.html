{% extends "base.html" %}
{% load humanize %}

{% block container_class %}wide-screen{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>ğŸ’° {{ year }}ë…„ {{ month }}ì›” ê¸‰ì—¬ ë‚´ì—­</h2>

    <form method="GET" style="display: flex; gap: 10px; align-items: center;">
        <select name="year" onchange="this.form.submit()" style="padding: 8px;">
            {% for y in year_range %}
            <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}ë…„</option>
            {% endfor %}
        </select>
        <select name="month" onchange="this.form.submit()" style="padding: 8px;">
            {% for m in month_range %}
            <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ m }}ì›”</option>
            {% endfor %}
        </select>
        <noscript><button type="submit">ì¡°íšŒ</button></noscript>
    </form>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">

    <div style="display: flex; gap: 10px;">
        <a href="{% url 'teacher_payroll_pdf' %}?year={{ year }}&month={{ month }}" target="_blank" class="btn" style="background-color: #e53935; padding: 8px 15px; font-size: 0.9rem;">
            ğŸ“„ PDFë¡œ ë‚´ë³´ë‚´ê¸°
        </a>
        <a href="{% url 'teacher_payroll_year_list' %}" class="btn" style="background-color: #009688; padding: 8px 15px; font-size: 0.9rem;">
            ğŸ“… ì—°ë„ë³„ ì§€ê¸‰ ë‚´ì—­
        </a>

        <form action="{% url 'teacher_payroll_bulk_process' %}" method="POST" id="bulkPaymentForm" style="margin: 0; display: inline;">
            {% csrf_token %}
            <input type="hidden" name="year" value="{{ year }}">
            <input type="hidden" name="month" value="{{ month }}">
            <input type="hidden" name="payment_date" id="bulk_payment_date_hidden">
            <button type="submit" class="btn" id="bulkPaymentButton"
                    onclick="return confirmBulkPayment(this, '{{ year }}', '{{ month }}');"
                    style="background-color: #1a237e; padding: 8px 15px; font-size: 0.9rem;">
                 ë¯¸ì§€ê¸‰ ì „ì²´ ì§€ê¸‰ ì²˜ë¦¬
            </button>
        </form>
    </div>

    <label for="id_payment_date" style="font-weight: bold; font-size: 0.95rem; display: flex; align-items: center; gap: 10px;">
        ì¼ê´„ ì§€ê¸‰ì¼ ì„ íƒ:
        <input type="date" id="id_payment_date"
               style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem;">
    </label>
</div>

{% if messages %}
<ul class="messages" style="margin-bottom: 15px; list-style: none; padding: 10px 15px; background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 4px;">
    {% for message in messages %}
    <li style="color: {% if 'ì˜¤ë¥˜' in message %}#e53935{% else %}#2e7d32{% endif %}; font-weight: bold;">{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}

<table>
    <thead>
        <tr>
            <th>êµì‚¬ëª…</th>
            <th>ì€í–‰ / ê³„ì¢Œë²ˆí˜¸</th>
            <th style="text-align: center;">ê·¼ë¬´ì¼ìˆ˜</th>
            <th style="text-align: center;">ê·¼ë¬´ì‹œê°„</th>
            <th style="text-align: right;">ê¸°ë³¸ê¸‰</th>
            <th style="text-align: right;">ì¶”ê°€ê¸‰ì—¬</th>
            <th style="text-align: right; color: #4527a0;">ì‹¤ì§€ê¸‰ì•¡</th>
            <th style="text-align: center;">ì§€ê¸‰ ìƒíƒœ</th>
            <th style="text-align: center;">ì²˜ë¦¬</th>
        </tr>
    </thead>
    <tbody>
        {% for row in payroll_data %}
        <tr>
            <td style="font-weight: bold;">{{ row.teacher.name }}</td>
            <td style="font-size: 0.9rem; color: #666;">
                {{ row.bank_name }} <br> {{ row.account_number }}
            </td>
            <td style="text-align: center;">{{ row.work_days }}ì¼</td>
            <td style="text-align: center;">{{ row.work_hours }}h</td>
            <td style="text-align: right;">{{ row.base_salary|intcomma }}ì›</td>
            <td style="text-align: right;">{{ row.extra_pay|intcomma }}ì›</td>
            <td style="text-align: right; font-weight: bold; color: #4527a0;">
                {{ row.total_salary|intcomma }}ì›
            </td>

            <td style="text-align: center; font-weight: bold;">
                {% with current_date=row.payment_date|default_if_none:""|date:"Y-m-d" %}
                {% if row.is_paid %}
                    <span style="color: #2e7d32;">ì™„ë£Œ ({{ current_date }})</span>
                {% else %}
                    <span style="color: #e53935;">ë¯¸ì§€ê¸‰</span>
                {% endif %}
                {% endwith %}
            </td>

            <td style="text-align: center;">
                {% if not row.is_paid %}
                    <form action="{% url 'teacher_payroll_process' %}" method="POST" class="payment-form" style="margin: 0; display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="teacher_id" value="{{ row.teacher.pk }}">
                        <input type="hidden" name="year" value="{{ year }}">
                        <input type="hidden" name="month" value="{{ month }}">
                        <input type="hidden" name="amount" value="{{ row.total_salary }}">
                        <input type="hidden" name="payment_date" class="payment-date-input">

                        <button type="submit" class="btn payment-button"
                            onclick="return handlePaymentAction(this, '{{ row.teacher.name }}', '{{ row.total_salary|intcomma }}', 'ì§€ê¸‰ ì²˜ë¦¬');"
                            style="padding: 5px 10px; font-size: 0.8rem; background-color: #2e7d32;">
                            ì§€ê¸‰ ì²˜ë¦¬
                        </button>
                    </form>
                {% else %}
                    <div style="display: flex; flex-direction: column; gap: 5px; align-items: center;">

                        <form action="{% url 'teacher_payroll_process' %}" method="POST" class="payment-form" style="margin: 0;">
                            {% csrf_token %}
                            <input type="hidden" name="teacher_id" value="{{ row.teacher.pk }}">
                            <input type="hidden" name="year" value="{{ year }}">
                            <input type="hidden" name="month" value="{{ month }}">
                            <input type="hidden" name="amount" value="{{ row.total_salary }}">
                            <input type="hidden" name="payment_date" class="payment-date-input">

                            <button type="submit" class="btn payment-button"
                                onclick="return handlePaymentAction(this, '{{ row.teacher.name }}', '{{ row.total_salary|intcomma }}', 'ì§€ê¸‰ì¼ ìˆ˜ì •', '{{ row.payment_date|date:"Y-m-d" }}');"
                                style="padding: 5px 10px; font-size: 0.8rem; background-color: #ff9800;">
                                ì§€ê¸‰ì¼ ìˆ˜ì •
                            </button>
                        </form>

                        <form action="{% url 'teacher_payroll_delete_record' %}" method="POST"
                            onsubmit="return confirm('ê²½ê³ : {{ row.teacher.name }} ì„ ìƒë‹˜ì˜ {{ year }}ë…„ {{ month }}ì›” ì§€ê¸‰ ê¸°ë¡ì„ ì‚­ì œí•˜ê³  ë¯¸ì§€ê¸‰ ìƒíƒœë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?');"
                            style="margin: 0;">
                            {% csrf_token %}
                            <input type="hidden" name="teacher_id" value="{{ row.teacher.pk }}">
                            <input type="hidden" name="year" value="{{ year }}">
                            <input type="hidden" name="month" value="{{ month }}">
                            <button type="submit" style="background: none; border: none; color: #e53935; cursor: pointer; font-size: 0.8rem; text-decoration: underline;">
                                ì§€ê¸‰ ì·¨ì†Œ
                            </button>
                        </form>
                    </div>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="9" style="text-align: center; padding: 30px;">
                í•´ë‹¹ ì›”ì˜ ê¸‰ì—¬ ì§€ê¸‰ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.
            </td>
        </tr>
        {% endfor %}
    </tbody>

    <tfoot>
        <tr style="background-color: #e8eaf6; border-top: 2px solid #3f51b5;">
            <td colspan="6" style="text-align: center; font-weight: bold; padding: 15px; font-size: 1.1rem; color: #1a237e;">
                {{ year }}ë…„ {{ month }}ì›” ê¸‰ì—¬ ì´ê³„
            </td>
            <td style="text-align: right; font-weight: bold; padding: 15px; font-size: 1.1rem; color: #d32f2f;">
                {{ grand_total|intcomma }}ì›
            </td>
            <td colspan="2"></td> </tr>
    </tfoot>

</table>

</table>

<script>
    const dateInput = document.getElementById('id_payment_date');
    const bulkDateHidden = document.getElementById('bulk_payment_date_hidden');

    // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
    function getTodayDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    /**
     * ê°œë³„ ì§€ê¸‰ ì²˜ë¦¬ ë˜ëŠ” ì§€ê¸‰ì¼ ìˆ˜ì •ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
     */
    function handlePaymentAction(button, name, amount, actionType, currentPaymentDate) {
        const dateValue = dateInput.value;

        if (!dateValue) {
            alert("ì§€ê¸‰ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return false;
        }

        // --- ì§€ê¸‰ì¼ ìˆ˜ì • ë¡œì§ (ê°œë³„ ì„ íƒ ìœ ë„) ---
        if (actionType === 'ì§€ê¸‰ì¼ ìˆ˜ì •') {

            // ì‚¬ìš©ìê°€ ë‚ ì§œë¥¼ ë³€ê²½í•˜ì§€ ì•Šê³  ê¸°ì¡´ DB ê°’ê³¼ ë™ì¼í•œ ë‚ ì§œë¥¼ ì„ íƒí•œ ê²½ìš°
            if (dateValue === currentPaymentDate) {
                 alert(`[${name} ì„ ìƒë‹˜] í˜„ì¬ ì§€ê¸‰ì¼ì€ ${currentPaymentDate} ì…ë‹ˆë‹¤. ë‚ ì§œë¥¼ ìˆ˜ì •í•˜ë ¤ë©´ ìƒë‹¨ ë‚ ì§œ ì„ íƒ í•„ë“œì—ì„œ ìƒˆë¡œìš´ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.`);
                 return false; // ì œì¶œì„ ë§‰ê³  ì¬ì„ íƒì„ ìœ ë„
            }
        }
        // --- ì§€ê¸‰ì¼ ìˆ˜ì • ë¡œì§ ë ---


        // --- í¼ ì œì¶œ ë° í™•ì¸ (ì§€ê¸‰ ì²˜ë¦¬ ë° ìˆ˜ì • ê³µí†µ) ---
        const form = button.closest('.payment-form');
        const hiddenDateInput = form.querySelector('.payment-date-input');
        hiddenDateInput.value = dateValue;

        // ìµœì¢… í™•ì¸ ë©”ì‹œì§€
        return confirm(`[${dateValue}] ë‚ ì§œë¡œ ${name} ì„ ìƒë‹˜ì˜ ${amount}ì› ê¸‰ì—¬ë¥¼ ${actionType}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
    }


    // ì¼ê´„ ì§€ê¸‰ ì²˜ë¦¬ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    function confirmBulkPayment(button, year, month) {
        const dateValue = dateInput.value;
        if (!dateValue) {
            alert("ì§€ê¸‰ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return false;
        }

        // ìˆ¨ê²¨ì§„ bulk form ë‚ ì§œ í•„ë“œì— ì„ íƒëœ ë‚ ì§œ ê°’ ì£¼ì…
        bulkDateHidden.value = dateValue;

        return confirm(`[${dateValue}] ë‚ ì§œë¡œ ${year}ë…„ ${month}ì›”ì˜ ë¯¸ì§€ê¸‰ëœ ëª¨ë“  ê¸‰ì—¬ë¥¼ ì¼ê´„ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
    }
</script>

{% endblock %}