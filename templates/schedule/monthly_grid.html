{% extends "base.html" %}

{% block container_class %}container-fluid.p-0{% endblock %}


{% block content %}
<style>

    html, body {
    height: 100%;
    margin: 0;
    overflow: hidden;
    }

    .container-fluid.p-0 {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
    }

    /* 1. ë ˆì´ì•„ì›ƒ: í™”ë©´ ì „ì²´ ë†’ì´ ì‚¬ìš© (ìŠ¤í¬ë¡¤ ê°€ë‘ê¸° í•µì‹¬) */
    /* base.htmlì—ì„œ body marginì„ 0ìœ¼ë¡œ í–ˆìœ¼ë¯€ë¡œ ì •í™•íˆ ê³„ì‚°ë©ë‹ˆë‹¤ */
    .full-width-container {
        width: 90%;
        /* ì „ì²´ ë†’ì´(100vh) - ë„¤ë¹„ê²Œì´ì…˜ ë†’ì´(ì•½ 73px) = ë‚¨ì€ ê³µê°„ */
        height: calc(100vh - 73px);
        display: flex;
        flex-direction: column;
        background-color: #f8f9fa;
        overflow: hidden; /* ìœˆë„ìš° ìŠ¤í¬ë¡¤ ì œê±° */
    }

    /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë°” */
    .control-bar {
        flex: 0 0 auto; /* ë†’ì´ ê³ ì • */
        padding: 10px 20px;
        background: #fff;
        border-bottom: 1px solid #ccc;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* ì§„ì§œ ìŠ¤í¬ë¡¤ì´ ìƒê¸°ëŠ” ê³³ */
    .spreadsheet-container {
        flex: 1; /* ë‚¨ì€ ë†’ì´ ëª¨ë‘ ì°¨ì§€ */
        overflow: auto; /* ì—¬ê¸°ì„œë§Œ ìŠ¤í¬ë¡¤! */
        background: white;
        position: relative;
    }

    /* 2. í…Œì´ë¸” ìŠ¤íƒ€ì¼ (Sticky í•„ìˆ˜: separate) */
    .sheet-table {
        min-width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 12px;
        table-layout: fixed;
    }

    .sheet-table th, .sheet-table td {
        border-right: 1px solid #c0c0c0;
        border-bottom: 1px solid #c0c0c0;
        padding: 0 4px;
        text-align: center;
        vertical-align: middle;
        height: 34px;
        white-space: nowrap;
        overflow: hidden;
        color: #333;
        box-sizing: border-box;
    }

    /* 3. ê³ ì •(Sticky) ì„¤ì • */

    /* (1) ìƒë‹¨ í—¤ë” ê³ ì • */
    .sheet-table thead th {
        position: sticky;
        top: 0;
        z-index: 100;
        background-color: #eef1f5;
        border-top: 1px solid #c0c0c0;
        border-bottom: 2px solid #999;
        font-weight: 600;
    }

    /* (2) ì¢Œì¸¡ ì—´ ê³ ì • (ë‚ ì§œ) */
    .sheet-table tbody td:nth-child(1) {
        position: sticky; left: 0; z-index: 90;
        background-color: #fff; border-right: 2px solid #b7b7b7; width: 80px; font-weight: bold;
    }
    /* (3) ì¢Œì¸¡ ì—´ ê³ ì • (ìš”ì¼) */
    .sheet-table tbody td:nth-child(2) {
        position: sticky; left: 80px; z-index: 90;
        background-color: #fff; border-right: 2px solid #b7b7b7; width: 40px;
    }

    /* (4) ì¢Œì¸¡ ìƒë‹¨ êµì°¨ì  ê³ ì • */
    .sheet-table thead th:nth-child(1) { position: sticky; top: 0; left: 0; z-index: 200; width: 80px; border-right: 2px solid #b7b7b7; }
    .sheet-table thead th:nth-child(2) { position: sticky; top: 0; left: 80px; z-index: 200; width: 40px; border-right: 2px solid #b7b7b7; }


    /* ê¸°íƒ€ ìŠ¤íƒ€ì¼ (ì…€, íŒì—… ë“± ê¸°ì¡´ ìœ ì§€) */
    .editable-cell { cursor: pointer; background-color: #fff; }
    .editable-cell:hover { background-color: #e8f0fe; outline: 2px solid #1a73e8; z-index: 10; }
    .day-off { background-color: #ff9800 !important; color: #fff; }
    .sunday { color: #d93025; } .saturday { color: #1967d2; }
    .changed-sum { color: #d93025; font-weight: 800; }

    /* íŒì—… */
    #student-selector { display: none; position: absolute; width: 220px; max-height: 300px; background: white; border: 1px solid #999; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 2000; border-radius: 4px; flex-direction: column; }
    #student-selector-header { padding: 8px; border-bottom: 1px solid #eee; background: #f8f9fa; }
    #student-search { width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; }
    #student-list-container { overflow-y: auto; flex: 1; padding: 5px 0; }
    .student-option { padding: 5px 10px; display: flex; align-items: center; cursor: pointer; font-size: 13px; }
    .student-option:hover { background-color: #e3f2fd; }
    .student-option input { margin-right: 8px; cursor: pointer; }
    .student-option.busy { display: none !important; }
</style>

<div class="control-bar">
    <div style="display: flex; align-items: center; gap: 15px;">
        <h4 style="margin:0; color: #202124; font-size: 1.1rem; font-weight: bold;">ğŸ“… {{ year }}ë…„ {{ month }}ì›” ìˆ˜ì—… ê´€ë¦¬</h4>
        <div class="btn-group">
            <a href="?year={{ year }}&month={{ month|add:'-1' }}" class="btn btn-sm btn-outline-secondary">â—€</a>
            <a href="?year={{ year }}&month={{ month|add:'1' }}" class="btn btn-sm btn-outline-secondary">â–¶</a>
        </div>
        <small style="color: #666;">* ì…€ í´ë¦­: í•™ìƒ ì„ íƒ / ìš°í´ë¦­: íœ´ë¬´ í† ê¸€</small>
    </div>
    <div>
        <button onclick="saveAllData()" class="btn btn-sm btn-primary" style="font-weight: bold; padding: 5px 20px;">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<div class="spreadsheet-container" id="grid-container">
    <table class="sheet-table">
        <thead>
            <tr>
                <th>ë‚ ì§œ</th>
                <th>ìš”ì¼</th>
                {% for teacher in teachers %}
                    <th style="min-width: 80px; background-color: #fff9c4;">{{ teacher.name }}</th>
                {% endfor %}
                <th style="width: 60px; background-color: #ffebee;">ê²°ì„</th>
                <th style="width: 60px; background-color: #fff3e0;">ì˜ˆì™¸</th>
                <th style="width: 50px; background-color: #e8f5e9;">í•©ê³„</th>
                <th style="width: 60px; background-color: #f3e5f5;">ì§€ê°</th>
                <th style="min-width: 200px;">íŠ¹ì´ì‚¬í•­</th>
            </tr>
        </thead>
        <tbody>
            {% for date, row in schedule_data.items %}
            <tr data-date="{{ date|date:'Y-m-d' }}">
                <td class="{% if row.day_name == 'Sun' %}sunday{% elif row.day_name == 'Sat' %}saturday{% endif %}">
                    {{ date|date:"Y. m. d" }}
                </td>
                <td class="{% if row.day_name == 'Sun' %}sunday{% elif row.day_name == 'Sat' %}saturday{% endif %}">
                    {{ row.day_name }}
                </td>

                {% for cell in row.teacher_cells %}
                    <td class="editable-cell {% if cell.is_off %}day-off{% endif %}"
                        data-type="teacher"
                        data-teacher-id="{{ cell.teacher.pk }}"
                        oncontextmenu="toggleDayOff(event, this)"
                        onclick="openStudentSelector(this)">
                        {% for stu in cell.students %}{{ stu.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                    </td>
                {% endfor %}

                <td class="editable-cell" data-type="absent" onclick="openStudentSelector(this)" style="background-color: #ffebee;">
                    {% for stu in row.log.absent_students.all %}{{ stu.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                </td>
                <td class="editable-cell" data-type="exception" onclick="openStudentSelector(this)" style="background-color: #fff3e0;">
                    {% for stu in row.log.exception_students.all %}{{ stu.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                </td>
                <td class="sum-cell" style="background-color: #e8f5e9; font-weight: bold; color: #137333;">{{ row.total_count }}</td>
                <td class="editable-cell" data-type="late" onclick="openStudentSelector(this)" style="background-color: #f3e5f5;">
                    {% for stu in row.log.late_students.all %}{{ stu.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                </td>
                <td contenteditable="true" class="editable-cell" data-type="remarks" style="text-align: left; padding-left: 5px; cursor: text;">
                    {{ row.log.remarks|default:"" }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="student-selector">
    <div id="student-selector-header">
        <input type="text" id="student-search" placeholder="í•™ìƒ ì´ë¦„ ê²€ìƒ‰..." autocomplete="off">
    </div>
    <div id="student-list-container">
        {% for student in all_students %}
            <div class="student-option" data-name="{{ student.name }}">
                <input type="checkbox" id="stu_{{ student.pk }}" value="{{ student.name }}">
                <label for="stu_{{ student.pk }}">{{ student.name }}</label>
            </div>
        {% endfor %}
    </div>
</div>

<script>
    /* ìë°”ìŠ¤í¬ë¦½íŠ¸ëŠ” ì´ì „ì— ì‘ì„±í•´ë“œë¦° 'ì™„ë²½ ë²„ì „'ê³¼ ë™ì¼í•©ë‹ˆë‹¤. */
    /* (ì§€ê° ë¶„ë¦¬, ì¤‘ë³µ í•„í„°ë§, ì €ì¥ ê¸°ëŠ¥ ëª¨ë‘ í¬í•¨ë¨) */
    let currentEditingCell = null;
    const selector = document.getElementById('student-selector');
    const searchInput = document.getElementById('student-search');
    const options = document.querySelectorAll('.student-option');

    function toggleDayOff(e, td) {
        e.preventDefault();
        td.classList.toggle('day-off');
    }

    function openStudentSelector(td) {
        if (currentEditingCell === td && selector.style.display === 'flex') {
            closeSelector(); return;
        }
        currentEditingCell = td;

        const rect = td.getBoundingClientRect();
        selector.style.display = 'flex';
        selector.style.top = (rect.bottom + window.scrollY) + 'px';
        selector.style.left = (rect.left + window.scrollX) + 'px';
        if (rect.left + 220 > window.innerWidth) selector.style.left = (window.innerWidth - 230) + 'px';

        const currentNames = td.innerText.split(',').map(s => s.trim());

        const currentRow = td.parentElement;
        const currentType = td.dataset.type;
        const busyNames = new Set();

        if (currentType !== 'late') {
            const siblingCells = currentRow.querySelectorAll('.editable-cell[data-type="teacher"], .editable-cell[data-type="absent"], .editable-cell[data-type="exception"]');
            siblingCells.forEach(cell => {
                if (cell === td) return;
                const names = cell.innerText.split(',').map(s => s.trim()).filter(s => s);
                names.forEach(n => busyNames.add(n));
            });
        }

        searchInput.value = '';
        options.forEach(opt => {
            const checkbox = opt.querySelector('input');
            const name = checkbox.value;

            if (busyNames.has(name)) {
                opt.classList.add('busy');
                opt.style.display = 'none';
                checkbox.checked = false;
            } else {
                opt.classList.remove('busy');
                opt.style.display = 'flex';
                checkbox.checked = currentNames.includes(name);
            }
        });
        searchInput.focus();
    }

    function closeSelector() {
        selector.style.display = 'none';
        currentEditingCell = null;
    }

    searchInput.addEventListener('input', function() {
        const keyword = this.value.toLowerCase();
        options.forEach(opt => {
            if (opt.classList.contains('busy')) return;
            const name = opt.dataset.name.toLowerCase();
            opt.style.display = name.includes(keyword) ? 'flex' : 'none';
        });
    });

    document.getElementById('student-list-container').addEventListener('change', function(e) {
        if (e.target.type === 'checkbox' && currentEditingCell) {
            updateCellFromSelection();
        }
    });

    function updateCellFromSelection() {
        if (!currentEditingCell) return;
        const selectedNames = [];
        options.forEach(opt => {
            const checkbox = opt.querySelector('input');
            if (checkbox.checked) selectedNames.push(checkbox.value);
        });
        currentEditingCell.innerText = selectedNames.join(', ');
        updateRowSum(currentEditingCell.parentElement);
    }

    document.addEventListener('click', function(e) {
        if (selector.contains(e.target) || (currentEditingCell && currentEditingCell.contains(e.target))) return;
        closeSelector();
    });

    function updateRowSum(tr) {
        const cells = tr.querySelectorAll('td[data-type="teacher"], td[data-type="absent"], td[data-type="exception"]');
        let sum = 0;
        cells.forEach(cell => {
            const text = cell.innerText.trim();
            if (text) sum += text.split(',').filter(s => s.trim().length > 0).length;
        });
        const sumCell = tr.querySelector('.sum-cell');
        const oldSum = parseInt(sumCell.innerText) || 0;
        if (sum !== oldSum) {
            sumCell.innerText = sum;
            sumCell.classList.add('changed-sum');
        }
    }

    function saveAllData() {
        const rows = document.querySelectorAll('tbody tr');
        const payload = [];
        rows.forEach(tr => {
            const date = tr.dataset.date;
            const rowData = { date: date, teachers: {}, logs: {} };
            tr.querySelectorAll('td[data-type="teacher"]').forEach(td => {
                const teacherId = td.dataset.teacherId;
                const text = td.innerText.trim();
                const isOff = td.classList.contains('day-off');
                rowData.teachers[teacherId] = { 'text': text, 'is_off': isOff };
            });
            tr.querySelectorAll('td[data-type="absent"], td[data-type="exception"], td[data-type="late"]').forEach(td => {
                rowData.logs[td.dataset.type] = td.innerText.trim();
            });
            const remarksTd = tr.querySelector('td[data-type="remarks"]');
            if (remarksTd) rowData.logs['remarks'] = remarksTd.innerText.trim();
            payload.push(rowData);
        });

        if (!confirm('ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        fetch("{% url 'save_monthly_schedule' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ schedules: payload })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            } else {
                alert('âŒ ì˜¤ë¥˜: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('í†µì‹  ì˜¤ë¥˜');
        });
    }
</script>
{% endblock %}