{% extends "base.html" %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto;">
    <div style="border-bottom: 2px solid #673ab7; margin-bottom: 20px; padding-bottom: 10px;">
        <h2>âš¡ ê·¼ë¬´ ê¸°ë¡ ì¼ê´„ ì…ë ¥</h2>
        <p style="color: #666;">ë‚ ì§œë¥¼ ì„ íƒí•˜ê³ , ê·¼ë¬´í•œ êµì‚¬ë¥¼ ì²´í¬í•œ ë’¤ ì‹œê°„ì„ í™•ì¸í•˜ì„¸ìš”.</p>
    </div>

    <form method="POST" class="info-card" style="padding: 30px;">
        {% csrf_token %}

        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 30px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
            <div>
                <label><strong>ğŸ“… ê·¼ë¬´ ë‚ ì§œ</strong></label>
                <input type="date" name="date" value="{{ today }}" required>
            </div>
            <div>
                <label><strong>ğŸ“ ë¹„ê³  (ì „ì²´ ì ìš©)</strong></label>
                <input type="text" name="memo" placeholder="ì˜ˆ: ì „ì²´ ë³´ê°•, íŠ¹ê°• ë“±">
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <label style="font-size: 1.1rem; margin: 0;"><strong>ğŸ‘¥ êµì‚¬ë³„ ì‹œê°„ ì„¤ì •</strong></label>
            <button type="button" onclick="toggleAll()" style="background: none; border: none; color: #673ab7; cursor: pointer; font-weight: bold;">
                [ì „ì²´ ì„ íƒ/í•´ì œ]
            </button>
        </div>

        <table style="border: 1px solid #eee;">
            <thead>
                <tr>
                    <th width="50" style="text-align: center;">ì„ íƒ</th>
                    <th>êµì‚¬ ì´ë¦„</th>
                    <th>ì‹œì‘ ì‹œê°„ (24h)</th>
                    <th>ì¢…ë£Œ ì‹œê°„ (24h)</th>
                </tr>
            </thead>
            <tbody>
                {% for teacher in teachers %}
                <tr onclick="toggleRow('{{ teacher.id }}')" style="cursor: pointer;">
                    <td style="text-align: center;">
                        <input type="checkbox" name="teacher_ids" value="{{ teacher.id }}" id="chk_{{ teacher.id }}"
                               style="transform: scale(1.2);">
                    </td>
                    <td>
                        <label for="chk_{{ teacher.id }}" style="cursor: pointer; font-weight: 500;">
                            {{ teacher.name }}
                        </label>
                    </td>
                    <td onclick="event.stopPropagation()">
                        <input type="time" name="start_time_{{ teacher.id }}" value="18:00" style="width: 100%;">
                    </td>
                    <td onclick="event.stopPropagation()">
                        <input type="time" name="end_time_{{ teacher.id }}" value="20:00" style="width: 100%;">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="margin-top: 30px; text-align: center;">
            <button type="submit" class="btn" style="padding: 12px 40px; font-size: 1.1rem;">
                ì¼ê´„ ì €ì¥í•˜ê¸°
            </button>
            <a href="{% url 'teacher_list' %}" class="btn" style="background-color: #757575; margin-left: 10px;">ì·¨ì†Œ</a>
        </div>
    </form>
</div>

<script>
    // ì „ì²´ ì„ íƒ/í•´ì œ
    function toggleAll() {
        const checkboxes = document.querySelectorAll('input[name="teacher_ids"]');
        const targetState = !checkboxes[0].checked;
        checkboxes.forEach(cb => cb.checked = targetState);
    }

    // í–‰ í´ë¦­ ì‹œ ì²´í¬ë°•ìŠ¤ í† ê¸€
    function toggleRow(id) {
        const checkbox = document.getElementById('chk_' + id);
        checkbox.checked = !checkbox.checked;
    }


    // [ì¶”ê°€] ë‚ ì§œ ë³€ê²½ ì‹œ ê·¼ë¬´ ë¶ˆê°€ êµì‚¬ ì²´í¬ ë¡œì§
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.querySelector('input[name="date"]');

        // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ë‚ ì§œë¡œ í•œ ë²ˆ ì²´í¬
        checkUnavailableTeachers(dateInput.value);

        // 2. ë‚ ì§œê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì²´í¬
        dateInput.addEventListener('change', function() {
            checkUnavailableTeachers(this.value);
        });
    });

    function checkUnavailableTeachers(date) {
        if (!date) return;

        // Django URLì„ JS fetchë¡œ í˜¸ì¶œ
        fetch(`{% url 'check_availability_api' %}?date=${date}`)
            .then(response => response.json())
            .then(data => {
                const ids = data.unavailable_ids;
                updateTeacherRows(ids);
            })
            .catch(error => console.error('Error:', error));
    }

    function updateTeacherRows(unavailableIds) {
        // ëª¨ë“  êµì‚¬ í–‰(row)ì„ ëŒë©´ì„œ ì´ˆê¸°í™”
        const rows = document.querySelectorAll('tbody tr');

        rows.forEach(row => {
            // tr íƒœê·¸ì˜ onclick ì†ì„±ì—ì„œ teacher ID ì¶”ì¶œ (ì˜ˆ: toggleRow('5'))
            // ì¢€ ë” ì•ˆì „í•˜ê²Œ input checkboxì˜ valueë¡œ ì°¾ìŠµë‹ˆë‹¤.
            const checkbox = row.querySelector('input[type="checkbox"]');
            const teacherId = parseInt(checkbox.value);
            const startInput = row.querySelector(`input[name="start_time_${teacherId}"]`);
            const endInput = row.querySelector(`input[name="end_time_${teacherId}"]`);
            const label = row.querySelector('label');

            // 1. ë§Œì•½ ê·¼ë¬´ ë¶ˆê°€ ëª©ë¡ì— ìˆë‹¤ë©´
            if (unavailableIds.includes(teacherId)) {
                // ìŠ¤íƒ€ì¼ ë³€ê²½ (ì—°í•œ ë¹¨ê°„ìƒ‰ ë°°ê²½)
                row.style.backgroundColor = '#ffebee';
                row.style.opacity = '0.7';

                // ì‹œê°„ ë¹„ìš°ê¸° [ìš”êµ¬ì‚¬í•­ 2]
                startInput.value = '';
                endInput.value = '';
                startInput.disabled = true; // ì…ë ¥ ëª»í•˜ê²Œ ë§‰ìŒ (ì„ íƒì‚¬í•­)
                endInput.disabled = true;

                // ì²´í¬ë°•ìŠ¤ í•´ì œ ë° ë¹„í™œì„±í™”
                checkbox.checked = false;
                checkbox.disabled = true;

                // ì´ë¦„ ì˜†ì— (ê·¼ë¬´ ë¶ˆê°€) í‘œì‹œ
                if (!label.innerText.includes('(íœ´ë¬´)')) {
                    label.innerText += ' (íœ´ë¬´)';
                    label.style.color = '#c62828';
                }
            }
            // 2. ê·¼ë¬´ ê°€ëŠ¥ ìƒíƒœë¼ë©´ (ì´ˆê¸°í™”)
            else {
                row.style.backgroundColor = '';
                row.style.opacity = '1';

                // ì‹œê°„ ê¸°ë³¸ê°’ ë³µêµ¬ (18:00, 20:00)
                if (startInput.value === '') startInput.value = '18:00';
                if (endInput.value === '') endInput.value = '20:00';
                startInput.disabled = false;
                endInput.disabled = false;

                checkbox.disabled = false;

                // (íœ´ë¬´) í…ìŠ¤íŠ¸ ì œê±°
                label.innerText = label.innerText.replace(' (íœ´ë¬´)', '');
                label.style.color = '';
            }
        });
    }
</script>
{% endblock %}