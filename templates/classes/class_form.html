{% extends "base.html" %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <h2 style="border-bottom: 2px solid #673ab7; padding-bottom: 10px; margin-bottom: 20px;">
        {{ title }}
    </h2>

    <div class="info-card" style="padding: 30px; background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
        <form method="POST">
            {% csrf_token %}

            <h4 style="color: #4527a0; margin-bottom: 15px; font-size: 1.1rem;">ğŸ“‹ ìˆ˜ì—… ì •ë³´</h4>

            <div style="margin-bottom: 20px;">
                <label for="id_name" style="font-weight: bold; display: block; margin-bottom: 5px;">ìˆ˜ì—…ëª… (ê°•ì¢Œëª…)</label>
                {{ form.name }}
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label for="id_teacher" style="font-weight: bold; display: block; margin-bottom: 5px;">ë‹´ë‹¹ êµì‚¬</label>
                    {{ form.teacher }}
                </div>
                <div>
                    <label for="id_tuition_fee" style="font-weight: bold; display: block; margin-bottom: 5px;">ìˆ˜ê°•ë£Œ (ì›”)</label>
                    {{ form.tuition_fee }}
                </div>
            </div>

            <div style="margin-bottom: 30px;">
                <label style="font-weight: bold; display: block; margin-bottom: 10px;">ğŸ“… ìˆ˜ì—… ì‹œê°„í‘œ ì„ íƒ</label>

                {{ form.schedule }}

                <div style="overflow-x: auto; border: 1px solid #ddd; border-radius: 5px;">
                    <table style="width: 100%; font-size: 0.9rem; text-align: center; border-collapse: collapse;">
                        <thead style="background-color: #f5f5f5;">
                            <tr>
                                <th style="padding: 8px; border-bottom: 1px solid #ddd; min-width: 60px;">ì‹œê°„</th>
                                {% for day in "ì›”í™”ìˆ˜ëª©ê¸ˆí† ì¼" %}
                                    <th style="padding: 8px; border-bottom: 1px solid #ddd;">{{ day }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% with "10 11 12 13 14 15 16 17 18 19 20 21 22" as times %}
                                {% for hour in times.split %}
                                <tr>
                                    <td style="padding: 6px; border-bottom: 1px solid #eee; font-weight: bold; color: #666; background-color: #fafafa;">
                                        {{ hour }}:00
                                    </td>
                                    {% for day in "ì›”í™”ìˆ˜ëª©ê¸ˆí† ì¼" %}
                                    <td style="padding: 6px; border-bottom: 1px solid #eee;">
                                        <input type="checkbox" class="time-slot"
                                               data-day="{{ day }}" data-hour="{{ hour }}"
                                               id="time_{{ day }}_{{ hour }}"
                                               style="transform: scale(1.2); cursor: pointer;">
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            {% endwith %}
                        </tbody>
                    </table>
                </div>
                <small style="color: #888;">* ì›í•˜ëŠ” ì‹œê°„ëŒ€ë¥¼ í´ë¦­í•˜ì„¸ìš”. (ì—°ì†ëœ ì‹œê°„ì€ ìë™ìœ¼ë¡œ ë¬¶ì–´ì„œ í‘œì‹œë©ë‹ˆë‹¤)</small>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label for="id_start_date" style="font-weight: bold; display: block; margin-bottom: 5px;">ê°œê°•ì¼</label>
                    {{ form.start_date }}
                </div>
                <div>
                    <label for="id_end_date" style="font-weight: bold; display: block; margin-bottom: 5px;">ì¢…ê°•ì¼</label>
                    {{ form.end_date }}
                </div>
            </div>

            <div style="margin-bottom: 30px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    {{ form.is_active }}
                    <strong style="color: #2e7d32;">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìˆ˜ì—…ì…ë‹ˆë‹¤ (ì²´í¬ í•´ì œ ì‹œ 'ì¢…ê°•' ì²˜ë¦¬)</strong>
                </label>
            </div>

            <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

            <div style="display: flex; justify-content: space-between; align-items: end; margin-bottom: 15px;">
                <h4 style="color: #4527a0; margin: 0; font-size: 1.1rem;">
                    ğŸ‘©â€ğŸ“ ìˆ˜ê°•ìƒ ì„ íƒ
                    <span style="font-size: 0.9rem; color: #666; font-weight: normal;">(í•™ë…„ë³„ ì •ë ¬)</span>
                </h4>

                <div style="background-color: #e3f2fd; padding: 5px 15px; border-radius: 20px; border: 1px solid #90caf9;">
                    <label for="id_enrollment_date" style="font-size: 0.9rem; font-weight: bold; color: #1565c0; margin-right: 5px;">
                        ğŸ“… ì ìš© ê¸°ì¤€ì¼:
                    </label>
                    {{ form.enrollment_date }}
                </div>
            </div>

            <div style="border: 1px solid #ccc; border-radius: 5px; padding: 20px; max-height: 500px; overflow-y: auto; background-color: #fafafa;">

                {% regroup all_students by get_grade_display as grade_list %}

                {% for grade in grade_list %}
                    <div style="margin-bottom: 25px;">
                        <h5 style="margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #ddd; color: #555; font-weight: bold;">
                            {{ grade.grouper }} <span style="font-size: 0.8rem; color: #888; font-weight: normal;">({{ grade.list|length }}ëª…)</span>
                        </h5>

                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;">
                            {% for student in grade.list %}
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; background: white; padding: 8px 12px; border-radius: 4px; border: 1px solid #eee; transition: 0.2s;"
                                       onmouseover="this.style.borderColor='#b39ddb'; this.style.backgroundColor='#f3e5f5';"
                                       onmouseout="if(!this.querySelector('input').checked){this.style.borderColor='#eee'; this.style.backgroundColor='white';}">

                                    <input type="checkbox" name="students" value="{{ student.pk }}"
                                           {% if student.pk in selected_ids %}checked{% endif %}
                                           style="transform: scale(1.2); cursor: pointer;">

                                    <span style="font-size: 0.95rem; font-weight: 500; color: #333;">{{ student.name }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                {% empty %}
                    <p style="text-align: center; color: #999; padding: 20px;">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endfor %}
            </div>

            <div style="text-align: right; font-size: 0.8rem; color: #666; margin-top: 5px;">
                * ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒí•˜ë©´ ìƒë‹¨ì˜ 'ì ìš© ê¸°ì¤€ì¼'ì— ë”°ë¼ ìˆ˜ê°•ë£Œê°€ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button type="submit" class="btn" style="padding: 12px 50px; font-size: 1.1rem; background-color: #4527a0; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    ì €ì¥í•˜ê¸°
                </button>
                <a href="{% url 'class_list' %}" class="btn" style="background-color: #757575; margin-left: 10px; padding: 12px 30px; color: white; text-decoration: none; border-radius: 5px;">
                    ì·¨ì†Œ
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const scheduleInput = document.getElementById('id_schedule');
        const checkboxes = document.querySelectorAll('.time-slot');

        // [1] ì´ˆê¸°í™”: DBì— ì €ì¥ëœ ìŠ¤ì¼€ì¤„ì´ ìˆë‹¤ë©´ ì²´í¬ë°•ìŠ¤ì— í‘œì‹œ (ìˆ˜ì • ëª¨ë“œ)
        if (scheduleInput.value) {
            // ì €ì¥ëœ ê°’ ì˜ˆì‹œ: "ì›”-10,ìˆ˜-14,ê¸ˆ-14"
            const savedSlots = scheduleInput.value.split(',');
            savedSlots.forEach(slot => {
                if (slot.trim() !== "") {
                    const parts = slot.split('-'); // [ì›”, 10]
                    if (parts.length === 2) {
                        const day = parts[0];
                        const hour = parts[1];
                        const checkbox = document.getElementById(`time_${day}_${hour}`);
                        if (checkbox) {
                            checkbox.checked = true;
                            // ì„ íƒëœ ì…€ ì‹œê° íš¨ê³¼
                            checkbox.parentElement.style.backgroundColor = '#e3f2fd';
                            checkbox.parentElement.style.borderBottom = '1px solid #90caf9';
                        }
                    }
                }
            });
        }

        // [2] ë³€ê²½ ê°ì§€: ì²´í¬ë°•ìŠ¤ë¥¼ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ ìˆ¨ê²¨ì§„ í•„ë“œ ì—…ë°ì´íŠ¸
        checkboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                updateScheduleInput();

                // ë°°ê²½ìƒ‰ í† ê¸€
                if (this.checked) {
                    this.parentElement.style.backgroundColor = '#e3f2fd';
                    this.parentElement.style.borderBottom = '1px solid #90caf9';
                } else {
                    this.parentElement.style.backgroundColor = 'transparent';
                    this.parentElement.style.borderBottom = '1px solid #eee';
                }
            });
        });

        function updateScheduleInput() {
            const selected = [];
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    // ë°ì´í„° í¬ë§·: "ìš”ì¼-ì‹œê°„" (ì˜ˆ: ì›”-10)
                    selected.push(`${cb.dataset.day}-${cb.dataset.hour}`);
                }
            });
            // ì½¤ë§ˆë¡œ ì—°ê²°í•´ì„œ hidden inputì— ì €ì¥
            scheduleInput.value = selected.join(',');
        }
    });
</script>
{% endblock %}