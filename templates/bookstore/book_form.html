{% extends "base.html" %}

{% block content %}
<div style="max-width: 700px; margin: 0 auto;">

    <h2 style="text-align: center; margin-bottom: 25px; color: #111827;">
        {{ title }}
    </h2>

    <div class="card">
        <form method="POST">
            {% csrf_token %}

            <div class="form-group">
                <label for="id_created_at" class="form-label">ğŸ“… ë“±ë¡ì¼ (ì…ê³ ì¼)</label>
                {{ form.created_at }}
            </div>

            <div class="form-group">
                <label for="id_isbn" class="form-label">ë°”ì½”ë“œ (ISBN)</label>
                {{ form.isbn }}
                <p style="font-size: 0.85rem; color: #6b7280; margin-top: 5px;">
                    * ë°”ì½”ë“œ ë¦¬ë”ê¸°ë¡œ ìŠ¤ìº”í•˜ê±°ë‚˜ ìˆ˜ë™ ì…ë ¥ í›„ Enter/Tabì„ ëˆ„ë¥´ì„¸ìš”.
                </p>
            </div>

            <div class="form-group">
                <label for="id_title" class="form-label">êµì¬ëª…</label>
                {{ form.title }}
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label for="id_author" class="form-label">ì €ì</label>
                    {{ form.author }}
                </div>
                <div>
                    <label for="id_publisher" class="form-label">ì¶œíŒì‚¬</label>
                    {{ form.publisher }}
                </div>
            </div>

            <div class="form-group" style="background-color: #F9FAFB; padding: 15px; border-radius: 8px; border: 1px solid #E5E7EB;">
                <label for="id_supplier" class="form-label" style="color: #4338CA;">
                    ğŸ¢ êµ¬ë§¤ì²˜ (ê³µê¸‰ì‚¬)
                </label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div style="flex-grow: 1;">
                        {{ form.supplier }}
                    </div>
                    <a href="#" id="add-supplier-btn" class="btn btn-outline"
                       style="white-space: nowrap; padding: 10px 15px; font-size: 0.9rem;">
                        + ìƒˆ êµ¬ë§¤ì²˜
                    </a>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label for="id_original_price" class="form-label">ì •ê°€</label>
                    {{ form.original_price }}
                </div>
                <div>
                    <label for="id_cost_price" class="form-label">ì…ê³ ê°€ (ì›ê°€)</label>
                    {{ form.cost_price }}
                </div>
                <div>
                    <label for="id_price" class="form-label">íŒë§¤ê°€</label>
                    {{ form.price }}
                </div>
            </div>

            <div class="form-group">
                <label for="id_stock" class="form-label">ì´ˆê¸° ì…ê³  ìˆ˜ëŸ‰</label>
                {{ form.stock }}
            </div>

            <div class="form-group">
                <label for="id_memo" class="form-label">ë¹„ê³ </label>
                {{ form.memo }}
            </div>

            <div style="margin-top: 30px; display: flex; gap: 10px;">
                <button type="submit" class="btn btn-primary" style="flex: 1; padding: 12px; font-size: 1rem;">
                    ì €ì¥í•˜ê¸°
                </button>
                <a href="{% url 'book_list' %}" class="btn btn-outline" style="padding: 12px; font-size: 1rem;">
                    ì·¨ì†Œ
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ëª¨ë“  ì…ë ¥ í•„ë“œì— ëª¨ë˜ ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ ê°•ì œ ì ìš©
        document.querySelectorAll('input, select, textarea').forEach(el => {
            el.classList.add('form-control'); // style.cssì— ì •ì˜ëœ ì˜ˆìœ ìŠ¤íƒ€ì¼
            // ì²´í¬ë°•ìŠ¤ ë“± ì˜ˆì™¸ì²˜ë¦¬ê°€ í•„ìš”í•˜ë©´ ì—¬ê¸°ì— ì¶”ê°€
        });

        const isbnInput = document.getElementById('id_isbn');

        // 1. ë°”ì½”ë“œ ìŠ¤ìº” ì²˜ë¦¬ ë° API í˜¸ì¶œ ë¡œì§
        if (isbnInput) {
            isbnInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === 'Tab') {
                    // Enterí‚¤ ì œì¶œ ë°©ì§€
                    if(e.key === 'Enter') e.preventDefault();

                    let rawValue = isbnInput.value.trim().replace(/-/g, '').toUpperCase();

                    // ISBN 10ìë¦¬ -> 13ìë¦¬ ë³€í™˜ ë¡œì§
                    if (rawValue.length === 10) {
                        const core = rawValue.substring(0, 9);
                        const prefix = "978";
                        const tempIsbn = prefix + core;
                        let sum = 0;
                        for (let i = 0; i < 12; i++) {
                            sum += parseInt(tempIsbn[i]) * (i % 2 === 0 ? 1 : 3);
                        }
                        let checkDigit = (10 - (sum % 10)) % 10;
                        if (checkDigit === 10) checkDigit = 0;
                        isbnInput.value = tempIsbn + checkDigit;
                    } else {
                        isbnInput.value = rawValue;
                    }

                    const finalIsbn = isbnInput.value;
                    if (finalIsbn !== "") {
                        fetchBookInfo(finalIsbn);
                    }
                }
            });
        }

        function fetchBookInfo(isbn) {
            // ì»¤ì„œ ëª¨ì–‘ ë³€ê²½ìœ¼ë¡œ ë¡œë”© í‘œì‹œ
            document.body.style.cursor = 'wait';

            // API í˜¸ì¶œ
            fetch(`/bookstore/api/search/?isbn=${isbn}`)
                .then(response => response.json())
                .then(data => {
                    document.body.style.cursor = 'default';
                    if (!data.error) {
                        const titleInput = document.getElementById('id_title');
                        const authorInput = document.getElementById('id_author');
                        const publisherInput = document.getElementById('id_publisher');
                        const originalPriceInput = document.getElementById('id_original_price');

                        if (titleInput && !titleInput.value) titleInput.value = data.title;
                        if (authorInput && !authorInput.value) authorInput.value = data.author;
                        if (publisherInput && !publisherInput.value) publisherInput.value = data.publisher;
                        if (originalPriceInput && data.price && data.price !== '0' && !originalPriceInput.value) {
                            originalPriceInput.value = data.price;
                        }
                        // ì œëª©ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
                        if (titleInput) titleInput.focus();
                    } else {
                        // ì—ëŸ¬ì—¬ë„ ì œëª©ìœ¼ë¡œ ì´ë™
                        const titleInput = document.getElementById('id_title');
                        if (titleInput) titleInput.focus();
                    }
                })
                .catch(error => {
                    document.body.style.cursor = 'default';
                    console.error('API Error:', error);
                    const titleInput = document.getElementById('id_title');
                    if (titleInput) titleInput.focus();
                });
        }

        // 2. [í•µì‹¬] êµ¬ë§¤ì²˜ ë“±ë¡ ì´ë™ ì‹œ ë°ì´í„° ë³´ì¡´ ë¡œì§
        const addSupplierBtn = document.getElementById('add-supplier-btn');
        if (addSupplierBtn) {
            addSupplierBtn.addEventListener('click', function(e) {
                e.preventDefault();

                const params = new URLSearchParams();
                // ì €ì¥í•  í•„ë“œ ëª©ë¡
                const fields = ['created_at', 'isbn', 'title', 'author', 'publisher', 'original_price', 'cost_price', 'price', 'stock', 'memo'];

                fields.forEach(field => {
                    const element = document.getElementById('id_' + field);
                    if (element && element.value) {
                        params.append(field, element.value);
                    }
                });

                // í˜„ì¬ ì…ë ¥ê°’ë“¤ì„ ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ìœ¼ë¡œ ë§Œë“¦
                const returnUrl = "{% url 'book_create' %}?" + params.toString();

                // next íŒŒë¼ë¯¸í„°ì— ë‹´ì•„ì„œ ì´ë™
                const targetUrl = "{% url 'supplier_create' %}?next=" + encodeURIComponent(returnUrl);
                window.location.href = targetUrl;
            });
        }
    });
</script>
{% endblock %}