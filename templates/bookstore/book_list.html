{% extends "base.html" %}
{% load humanize %}

{% block container_class %}wide-screen{% endblock %}

{% block content %}
<div style="width: 100%;">
    <div style="margin-bottom: 20px; text-align: center;">
        <form method="GET" action="{% url 'book_list' %}" style="display: flex; gap: 10px; justify-content: center;">
            <input type="text" name="q" value="{{ query }}"
                   id="search_query"
                   placeholder="ë„ì„œëª…, ì €ì ë˜ëŠ” ë°”ì½”ë“œ(ISBN)"
                   style="padding: 10px; width: 50%; min-width: 300px; font-size: 1.1rem; border: 2px solid #673ab7; border-radius: 5px;">
            <button type="submit" class="btn" style="background-color: #673ab7; padding: 10px 20px; font-size: 1.1rem;">ê²€ìƒ‰</button>
        </form>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h2 style="color: #4527a0; margin: 0;">ğŸ“š êµì¬ ëª©ë¡</h2>

        <div style="display: flex; gap: 10px;">
            <a href="{% url 'book_upload' %}" class="btn" style="background-color: #2e7d32;">
                ğŸ“‚ êµì¬ ì¼ê´„ ë“±ë¡
            </a>
            <a href="{% url 'book_create' %}" class="btn" style="background-color: #ff9800;">
                + ì‹ ê·œ êµì¬ ì…ê³ 
            </a>
        </div>
    </div>

    <table style="width: 100%; border-collapse: collapse; background-color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <thead style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">
            <tr>
                <th style="padding: 12px; white-space: nowrap;">ISBN</th>
                <th style="padding: 12px;">êµì¬ëª…</th>
                <th style="padding: 12px;">ì¶œíŒì‚¬</th>
                <th style="padding: 12px; text-align: right; white-space: nowrap;">ì¬ê³ </th>
                <th style="padding: 12px; text-align: right; white-space: nowrap;">íŒë§¤ê°€</th>
                <th style="padding: 12px; text-align: center; width: 150px;">ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody>
            {% for book in page_obj %}
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 12px; color: #666; font-size: 0.9rem;">{{ book.isbn }}</td>
                <td style="padding: 12px; font-weight: bold;">
                    <a href="{% url 'book_update' book.pk %}" style="text-decoration: none; color: #333;">
                        {{ book.title }}
                    </a>
                </td>
                <td style="padding: 12px;">{{ book.publisher }}</td>
                <td style="padding: 12px; text-align: right;">
                    {% if book.stock <= 5 %}
                        <span style="color: #d32f2f; font-weight: bold;">{{ book.stock }}ê¶Œ</span>
                    {% else %}
                        <span style="color: #2e7d32; font-weight: bold;">{{ book.stock }}ê¶Œ</span>
                    {% endif %}
                </td>
                <td style="padding: 12px; text-align: right;">{{ book.price|intcomma }}ì›</td>
                <td style="padding: 12px; text-align: center;">
                    <div style="display: flex; gap: 5px; justify-content: center;">
                        <a href="{% url 'book_restock' book.pk %}" class="btn" style="background-color: #2196f3; padding: 4px 8px; font-size: 0.8rem; white-space: nowrap;">ì¶”ê°€ì…ê³ </a>
                        <a href="{% url 'book_return' book.pk %}" class="btn" style="background-color: #e53935; padding: 4px 8px; font-size: 0.8rem; white-space: nowrap;">ë°˜í’ˆ</a>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                    {% if query %}
                        <p style="font-size: 1.1rem; color: #d32f2f; font-weight: bold;">ğŸ” '{{ query }}' ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p>ì ì‹œ í›„ ì‹ ê·œ ë“±ë¡ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...</p>
                    {% else %}
                        <p>ë“±ë¡ëœ êµì¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div style="margin-top: 20px; text-align: center;">
        {% if page_obj.has_previous %}
            <a href="?page=1&q={{ query }}" class="btn" style="background: #eee; color: #333;">ì²˜ìŒ</a>
            <a href="?page={{ page_obj.previous_page_number }}&q={{ query }}" class="btn" style="background: #eee; color: #333;">ì´ì „</a>
        {% endif %}
        <span style="margin: 0 10px;">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&q={{ query }}" class="btn" style="background: #eee; color: #333;">ë‹¤ìŒ</a>
            <a href="?page={{ page_obj.paginator.num_pages }}&q={{ query }}" class="btn" style="background: #eee; color: #333;">ë§ˆì§€ë§‰</a>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search_query');

        // 1. ìë™ í¬ì»¤ìŠ¤
        if (searchInput) {
            const val = searchInput.value;
            searchInput.value = '';
            searchInput.focus();
            searchInput.value = val;
        }

        // 2. ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ -> ìë™ ì´ë™ ë¡œì§
        const isSearchEmpty = "{{ is_search_empty|yesno:'true,false' }}" === "true";

        if (isSearchEmpty) {
            setTimeout(function() {
                if (confirm("ê²€ìƒ‰ëœ êµì¬ê°€ ì—†ìŠµë‹ˆë‹¤.\n\n'ì‹ ê·œ êµì¬ ì…ê³ ' í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    const isbnValue = searchInput.value;
                    window.location.href = "{% url 'book_create' %}?isbn=" + encodeURIComponent(isbnValue);
                } else {
                    if (searchInput) searchInput.focus();
                }
            }, 100);
        }
    });
</script>
{% endblock %}